enum RoomType {
  MOVIE
  TV
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

generator dbseed {
  provider = "prisma-client-js"
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String?
  roles        String[]      @default([])
  members      RoomMember[]
  swipes       Swipe[]
  subscription Subscription?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Room {
  id        String       @id @default(cuid())
  code      String       @unique
  name      String       @default("Untitled Room")
  capacity  Int          @default(10)
  type        RoomType   @default(MOVIE)
  genreId     Int        @default(0)
  selectedTmdbId  Int?

  // Advanced filters
  minRating           Float?   // Note minimum (ex: 7.0)
  releaseYearMin      Int?     // Année de sortie min (ex: 2020)
  releaseYearMax      Int?     // Année de sortie max (ex: 2024)
  runtimeMin          Int?     // Durée minimum en minutes
  runtimeMax          Int?     // Durée maximum en minutes
  watchProviders      Int[]    @default([]) // IDs des plateformes (Netflix=8, Prime=119, etc.)
  watchRegion         String?  @default("FR") // Région pour les watch providers
  originalLanguage    String?  // Langue originale (ex: "en", "fr", "ja")

  members   RoomMember[]
  matches   Match[]
  createdBy String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @default(now()) @updatedAt
  deletedAt DateTime?

  @@index([type, genreId])
  @@index([deletedAt])
}

model RoomMember {
  id     String @id @default(cuid())
  roomId String
  userId String
  room   Room   @relation(fields: [roomId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
}

model Swipe {
  id        String   @id @default(cuid())
  roomId    String
  userId    String
  movieId   String
  value     Boolean
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])

  @@index([roomId])
  @@index([userId])
  @@index([roomId, movieId])
  @@unique([roomId, userId, movieId], name: "userId_roomId_movieId")
}

model Match {
  id        String   @id @default(cuid())
  roomId    String
  movieId   String
  createdAt DateTime @default(now())
  room      Room     @relation(fields: [roomId], references: [id])

  @@index([roomId])
  @@index([createdAt])
  @@unique([roomId, movieId])
}

enum SubscriptionPlan {
  FREE
  STARTER
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  INCOMPLETE
}

model Subscription {
  id     String   @id @default(cuid())
  userId String   @unique
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe integration
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // Subscription details
  plan   SubscriptionPlan   @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([plan])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}
