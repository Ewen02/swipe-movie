
enum RoomType {
  MOVIE
  TV
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

generator dbseed {
  provider = "prisma-client-js"
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  name             String?
  emailVerified    Boolean        @default(false)
  image            String?
  roles            String[]       @default([])
  stripeCustomerId String?        @unique
  members          RoomMember[]
  swipes           Swipe[]
  subscriptions    Subscription[]
  sessions         Session[]
  accounts         Account[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

// Better Auth - Sessions table

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// Better Auth - OAuth Accounts table

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([providerId, accountId])
}

// Better Auth - Email Verification table

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

model Room {
  id             String   @id @default(cuid())
  code           String   @unique
  name           String   @default("Untitled Room")
  capacity       Int      @default(10)
  type           RoomType @default(MOVIE)
  genreId        Int      @default(0)
  selectedTmdbId Int?

  // Advanced filters
  minRating        Float? // Note minimum (ex: 7.0)
  releaseYearMin   Int? // Année de sortie min (ex: 2020)
  releaseYearMax   Int? // Année de sortie max (ex: 2024)
  runtimeMin       Int? // Durée minimum en minutes
  runtimeMax       Int? // Durée maximum en minutes
  watchProviders   Int[]   @default([]) // IDs des plateformes (Netflix=8, Prime=119, etc.)
  watchRegion      String? @default("FR") // Région pour les watch providers
  originalLanguage String? // Langue originale (ex: "en", "fr", "ja")

  members   RoomMember[]
  matches   Match[]
  createdBy String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @default(now()) @updatedAt
  deletedAt DateTime?

  @@index([type, genreId])
  @@index([deletedAt])
}

model RoomMember {
  id     String @id @default(cuid())
  roomId String
  userId String
  room   Room   @relation(fields: [roomId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
}

model Swipe {
  id        String   @id @default(cuid())
  roomId    String
  userId    String
  movieId   String
  value     Boolean
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([roomId])
  @@index([userId])
  @@index([roomId, movieId])
  @@unique([roomId, userId, movieId], name: "userId_roomId_movieId")
}

model Match {
  id        String   @id @default(cuid())
  roomId    String
  movieId   String
  createdAt DateTime @default(now())
  room      Room     @relation(fields: [roomId], references: [id])

  @@index([roomId])
  @@index([createdAt])
  @@unique([roomId, movieId])
}

// Better Auth Stripe - Subscription table
model Subscription {
  id                   String    @id @default(cuid())
  plan                 String    // Plan name (e.g., "pro", "free")
  referenceId          String    // User ID or Organization ID
  stripeCustomerId     String?
  stripeSubscriptionId String?
  status               String    @default("incomplete")
  periodStart          DateTime?
  periodEnd            DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  seats                Int?
  trialStart           DateTime?
  trialEnd             DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relation to user
  user User @relation(fields: [referenceId], references: [id], onDelete: Cascade)

  @@index([referenceId])
  @@index([plan])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}
