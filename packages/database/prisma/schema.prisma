// SwipeMovie - Shared Prisma Schema
// This is the single source of truth for the database schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==========================================
// Enums
// ==========================================

enum RoomType {
  MOVIE
  TV
}

// ==========================================
// User & Authentication (Better Auth)
// ==========================================

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  name             String?
  emailVerified    Boolean        @default(false)
  image            String?
  roles            String[]       @default([])
  stripeCustomerId String?        @unique
  members          RoomMember[]
  swipes           Swipe[]
  subscriptions    Subscription[]
  sessions         Session[]
  accounts         Account[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([providerId, accountId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

// ==========================================
// Rooms & Swipes
// ==========================================

model Room {
  id             String   @id @default(cuid())
  code           String   @unique
  name           String   @default("Untitled Room")
  capacity       Int      @default(10)
  type           RoomType @default(MOVIE)
  genreId        Int      @default(0)
  selectedTmdbId Int?

  // Advanced filters
  minRating        Float?
  releaseYearMin   Int?
  releaseYearMax   Int?
  runtimeMin       Int?
  runtimeMax       Int?
  watchProviders   Int[]   @default([])
  watchRegion      String? @default("FR")
  originalLanguage String?

  members   RoomMember[]
  matches   Match[]
  createdBy String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @default(now()) @updatedAt
  deletedAt DateTime?

  @@index([type, genreId])
  @@index([deletedAt])
}

model RoomMember {
  id     String @id @default(cuid())
  roomId String
  userId String
  room   Room   @relation(fields: [roomId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
}

model Swipe {
  id        String   @id @default(cuid())
  roomId    String
  userId    String
  movieId   String
  value     Boolean
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([roomId, userId, movieId], name: "userId_roomId_movieId")
  @@index([roomId])
  @@index([userId])
  @@index([roomId, movieId])
}

model Match {
  id        String   @id @default(cuid())
  roomId    String
  movieId   String
  createdAt DateTime @default(now())
  room      Room     @relation(fields: [roomId], references: [id])

  @@unique([roomId, movieId])
  @@index([roomId])
  @@index([createdAt])
}

// ==========================================
// Subscriptions (Better Auth Stripe)
// ==========================================

model Subscription {
  id                   String    @id @default(cuid())
  plan                 String
  referenceId          String
  stripeCustomerId     String?
  stripeSubscriptionId String?
  status               String    @default("incomplete")
  periodStart          DateTime?
  periodEnd            DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  seats                Int?
  trialStart           DateTime?
  trialEnd             DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user User @relation(fields: [referenceId], references: [id], onDelete: Cascade)

  @@index([referenceId])
  @@index([plan])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}
