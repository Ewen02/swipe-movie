name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-web:
    name: Deploy Web to Vercel
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: apps/web

      - name: Build Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: apps/web
        env:
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.SENTRY_DSN_WEB }}

      - name: Deploy to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: apps/web

      - name: Deployment Summary
        run: |
          echo "‚úÖ Web application deployed to Vercel"
          echo "üîó Check deployment at: https://swipe-movie.vercel.app"

  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    environment: production
    # Note: Adjust deployment steps based on your hosting provider
    # This is a placeholder for API deployment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build API
        run: cd apps/api && npm run build
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN_API }}

      - name: Deployment Placeholder
        run: |
          echo "üöÄ API build completed"
          echo "‚ö†Ô∏è  Configure your deployment provider (Railway, Render, AWS, etc.)"
          echo "üì¶ Build artifacts are ready in apps/api/dist"

      # Example for Railway deployment:
      # - name: Deploy to Railway
      #   uses: bervProject/railway-deploy@main
      #   with:
      #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
      #     service: api

      # Example for generic deployment with SSH:
      # - name: Deploy via SSH
      #   uses: appleboy/scp-action@master
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_KEY }}
      #     source: "apps/api/dist"
      #     target: "/var/www/api"

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-api]
    if: always()

    steps:
      - name: Deployment Status
        run: |
          echo "Deployment Summary:"
          echo "- Web: ${{ needs.deploy-web.result }}"
          echo "- API: ${{ needs.deploy-api.result }}"

          if [ "${{ needs.deploy-web.result }}" == "success" ]; then
            echo "‚úÖ Web deployment successful"
          else
            echo "‚ùå Web deployment failed"
          fi

          if [ "${{ needs.deploy-api.result }}" == "success" ]; then
            echo "‚úÖ API deployment successful"
          else
            echo "‚ùå API deployment failed"
          fi
